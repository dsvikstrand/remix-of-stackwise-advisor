%% Stage 0/0.5/1 LAS graph + planned DAS v1 gates (Mermaid v11+)
%% Source of truth: codex/skills/seed-blueprints/scripts/seed_stage0.ts

flowchart TD
  %% Stage markers (stadium)
  ST_IN([STAGE Inputs]) -.-> IN_SPEC
  ST_PP([STAGE Compose Prompts]) -.-> PROMPT_PACK
  ST_AUTH([STAGE Auth]) -.-> AUTH_READ
  ST_LIB([STAGE Generate Library]) -.-> LIB_GEN
  ST_BP([STAGE Generate Blueprints]) -.-> BP_GEN
  ST_AI([STAGE Stage 0.5 Execute AI]) -.-> AI_REVIEW
  ST_APPLY([STAGE Stage 1 Apply Mode]) -.-> APPLY_START
  ST_PERS([STAGE Persona Contract]) -.-> PERS_SCHEMA
  ST_DAS([STAGE DAS gates and retries]) -.-> LIB_EVAL
  ST_DAS -.-> BP_EVAL
  ST_DAS -.-> PP_EVAL
  ST_DAS -.-> DAS_CFG

  %% Stage-based styling
  classDef stage_marker fill:#0b1220,stroke:#253047,color:#e7eefc,stroke-width:1px;
  classDef stage_inputs fill:#102a43,stroke:#1e4e8c,color:#e7f0ff;
  classDef stage_auth fill:#11324a,stroke:#2563eb,color:#e7f0ff;
  classDef stage_comp fill:#1c1b3a,stroke:#6366f1,color:#eef2ff;
  classDef stage_lib fill:#0f3d2e,stroke:#1b6b4b,color:#e7fff2;
  classDef stage_bps fill:#3a2a10,stroke:#8a5b12,color:#fff4e5;
  classDef stage_ai fill:#3b1030,stroke:#7d1f66,color:#ffe8f7;
  classDef stage_apply fill:#2a133a,stroke:#5b2a88,color:#f4eaff;
  classDef stage_pers fill:#0b2f3a,stroke:#06b6d4,color:#e6feff;
  classDef das_gate fill:#0b2a2f,stroke:#0ea5b7,color:#e6feff;
  classDef das_cfg fill:#122642,stroke:#38bdf8,color:#e0f2fe;
  classDef note fill:#111827,stroke:#374151,color:#e5e7eb,stroke-dasharray: 3 3;
  classDef done fill:#0b2f1a,stroke:#1f8a3a,color:#eafff1;
  classDef todo fill:#2f2f2f,stroke:#6b7280,color:#f3f4f6,stroke-dasharray: 4 3;

  %% Inputs + runner
  IN_SPEC["IN_SPEC seed/seed_spec_v0.json (Seed Spec) TESTED_OK"] --> IN_RUN["IN_RUN seed_stage0.ts (parse args + validate spec) TESTED_OK"]
  IN_RUN --> OUT_DIR["OUT_DIR Create run folder seed/outputs/RUN_ID/ TESTED_OK"]
  IN_RUN -.-> DAS_CFG["DAS_CFG seed/das_config_v1.json (DAS policy) TESTED_OK"]
  IN_RUN -.-> PERS_SCHEMA["PERS_SCHEMA docs/persona_schema.md (persona contract) TESTED_OK"]

  %% Prompt pack (optional, template v0)
  OUT_DIR -.->|--compose-prompts| PROMPT_PACK["PROMPT_PACK compose prompts (template v0) TESTED_OK"]
  DAS_CFG -.-> PP_EVAL
  PROMPT_PACK --> PP_CAND["PP_CAND Write candidates/PROMPT_PACK/attempt-xx-cand-yy.json TESTED_OK"]
  PP_CAND --> PP_EVAL{"PP_EVAL eval_structural + eval_bounds + persona_alignment_v0 TESTED_OK"}
  PP_EVAL -->|pass| PP_SEL["PP_SEL score + select best candidate TESTED_OK"]
  PP_EVAL -->|fail and attempt lt max| PP_RETRY["PP_RETRY retry (maxAttempts=2) TESTED_OK"]
  PP_RETRY --> PROMPT_PACK
  PP_SEL --> PP_OUT["PP_OUT Write requests/prompt_pack.json TESTED_OK"]
  PROMPT_PACK --> PP_LOG["PP_LOG Write logs/prompt_pack_log.json TESTED_OK"]
  PP_OUT --> AUTH_READ
  N_PP{{NOTE composed prompts override specRun library + blueprints}} --> PROMPT_PACK
  N_PP2{{NOTE v0 is template; LLM composer is TODO}} --> PROMPT_PACK

  %% Auth
  OUT_DIR --> AUTH_READ["AUTH_READ Load auth store + tokens (refresh supported) TESTED_OK"]
  N_AUTH{{NOTE access token expires; refresh supported via auth store}} --> AUTH_READ
  N_AUTH2{{NOTE refresh flow verified by forcing access token rotation}} --> AUTH_READ
  N_OUT{{NOTE seed outputs are artifacts; do not commit seed/outputs}} --> OUT_DIR

  %% Persona contract (planned)
  PERS_SCHEMA --> PERS_PROFILE["PERS_PROFILE personas/v0/PERSONA_ID.json (persona profile) TESTED_OK"]
  PERS_PROFILE --> PERS_LOG["PERS_LOG Write logs/persona_log.json (applied prompt block) TESTED_OK"]
  PERS_PROFILE -.-> AUTH_READ
  N_PERS{{NOTE persona is repo global, used by seeding and future agents}} --> PERS_SCHEMA
  N_PERS2{{NOTE persona prompt is appended into LIB_GEN customInstructions and BP_GEN notes}} --> PERS_LOG

  %% Library generation (candidate -> eval -> select)
  AUTH_READ --> LIB_GEN["LIB_GEN n1 generate_library POST /api/generate-inventory TESTED_OK"]
  DAS_CFG -.-> LIB_EVAL
  LIB_GEN --> LIB_CAND["LIB_CAND Write candidates/LIB_GEN/attempt-xx-cand-yy.json TESTED_OK"]
  LIB_CAND --> LIB_EVAL{"LIB_EVAL eval_structural + eval_bounds TESTED_OK"}
  LIB_EVAL -->|pass| LIB_SEL["LIB_SEL score + select best candidate TESTED_OK"]
  LIB_EVAL -->|struct/bounds fail and attempt lt max| LIB_RETRY["LIB_RETRY tighten prompt + retry (maxAttempts=2) TESTED_OK"]
  LIB_EVAL -->|safety/pii fail| ABORT["ABORT hard fail run (seeding mode) NOT_TESTED"]
  LIB_RETRY --> LIB_GEN
  LIB_SEL --> LIB_OUT["LIB_OUT Write artifacts/library.json TESTED_OK"]

  N_DAS{{NOTE DAS gates run only when DAS is enabled}} --> LIB_EVAL
  N_CFG{{NOTE per-node maxAttempts and kCandidates live in DAS_CFG}} --> DAS_CFG
  N_DAS2{{NOTE safety and PII failures are non-retryable in seeding mode}} --> ABORT

  %% Blueprint generation (per-variant candidates -> eval -> select)
  LIB_OUT --> BP_GEN["BP_GEN n2 generate_blueprints POST /api/generate-blueprint TESTED_OK"]
  DAS_CFG -.-> BP_EVAL
  BP_GEN --> BP_CAND["BP_CAND Write candidates/BP_GEN/attempt-xx-cand-yy.json TESTED_OK"]
  BP_CAND --> BP_EVAL{"BP_EVAL eval_structural + eval_bounds TESTED_OK"}
  BP_EVAL -->|pass| BP_SEL["BP_SEL score + select best candidate TESTED_OK"]
  BP_EVAL -->|struct/bounds fail and attempt lt max| BP_RETRY["BP_RETRY tighten prompt + retry (maxAttempts=2) TESTED_OK"]
  BP_EVAL -->|safety/pii fail| ABORT
  BP_RETRY --> BP_GEN
  BP_SEL --> BP_OUT["BP_OUT Write artifacts/blueprints.json TESTED_OK"]

  %% Request payloads (no network)
  BP_OUT --> REQ_REVIEW["REQ_REVIEW build review_requests (no network) TESTED_OK"]
  REQ_REVIEW --> OUT_REVIEW_REQ["OUT_REVIEW_REQ Write requests/review_requests.json TESTED_OK"]
  OUT_REVIEW_REQ --> REQ_BANNER["REQ_BANNER build banner_requests (no network) TESTED_OK"]
  REQ_BANNER --> OUT_BANNER_REQ["OUT_BANNER_REQ Write requests/banner_requests.json TESTED_OK"]

  %% Stage 0.5 (optional network)
  OUT_BANNER_REQ -.->|--do-review| AI_REVIEW["AI_REVIEW execute_review POST /api/analyze-blueprint TESTED_OK"]
  AI_REVIEW --> OUT_REVIEWS["OUT_REVIEWS Write ai/reviews.json TESTED_OK"]
  OUT_REVIEWS -.->|--do-banner| AI_BANNER["AI_BANNER execute_banner POST /api/generate-banner dryRun TESTED_OK"]
  AI_BANNER --> OUT_BANNERS["OUT_BANNERS Write ai/banners.json TESTED_OK"]
  N_SSE{{NOTE analyze-blueprint is SSE; runner stitches to text}} --> AI_REVIEW
  N_DRY{{NOTE generate-banner dryRun returns base64; no Storage write}} --> AI_BANNER

  %% Validate + publish payload (no writes)
  OUT_BANNER_REQ --> VAL["VAL validate category+item references TESTED_OK"]
  OUT_BANNERS -.-> VAL
  VAL --> OUT_VAL["OUT_VAL Write artifacts/validation.json TESTED_OK"]
  OUT_VAL --> PAYLOAD["PAYLOAD publish_payload (no writes) TESTED_OK"]
  PAYLOAD --> OUT_PAYLOAD["OUT_PAYLOAD Write artifacts/publish_payload.json TESTED_OK"]
  OUT_PAYLOAD --> RUNLOG["RUNLOG Append logs/run_log.json timings+status TESTED_OK"]
  RUNLOG --> DONE["DONE artifacts complete TESTED_OK"]

  %% Stage 1 apply mode (optional writes)
  OUT_PAYLOAD -.->|--apply + --yes APPLY_STAGE1| APPLY_START["APPLY_START Stage 1 apply mode TESTED_OK"]
  APPLY_START --> APPLY_INV["APPLY_INV Insert inventory/library into DB TESTED_OK"]
  APPLY_INV --> APPLY_BP["APPLY_BP Insert blueprint drafts into DB TESTED_OK"]
  APPLY_BP --> APPLY_BANNER["APPLY_BANNER Upload banner via upload-banner edge function TESTED_OK"]
  APPLY_BANNER --> APPLY_REVIEW["APPLY_REVIEW Persist review text to blueprint row TESTED_OK"]
  APPLY_REVIEW --> APPLY_PUB["APPLY_PUB Publish public blueprint finalize TESTED_OK"]
  N_APPLY{{NOTE apply writes logs/apply_log.json + logs/rollback.sql}} --> APPLY_START
  N_APPLY2{{NOTE publish sets is_public true on created rows}} --> APPLY_PUB

  %% TODO (future but expected in full DAS)
  BP_SEL -.-> TODO_ASP_EVAL["TODO_ASP_EVAL eval_asp_alignment (persona) NOT_TESTED"]
  BP_SEL -.-> TODO_GRADER["TODO_GRADER optional LLM grader for alignment/safety NOT_TESTED"]
  LIB_SEL -.-> TODO_COST["TODO_COST cost tracking + token accounting NOT_TESTED"]

  %% Styling assignments
  class ST_IN,ST_AUTH,ST_LIB,ST_BP,ST_AI,ST_APPLY,ST_PERS,ST_DAS stage_marker;
  class IN_SPEC,IN_RUN,OUT_DIR stage_inputs;
  class ST_PP stage_marker;
  class PROMPT_PACK,PP_OUT,PP_LOG stage_comp;
  class AUTH_READ stage_auth;
  class LIB_GEN,LIB_OUT stage_lib;
  class BP_GEN,BP_OUT,REQ_REVIEW,OUT_REVIEW_REQ,REQ_BANNER,OUT_BANNER_REQ stage_bps;
  class AI_REVIEW,OUT_REVIEWS,AI_BANNER,OUT_BANNERS stage_ai;
  class VAL,OUT_VAL,PAYLOAD,OUT_PAYLOAD,RUNLOG,DONE stage_inputs;
  class APPLY_START,APPLY_INV,APPLY_BP,APPLY_BANNER,APPLY_REVIEW,APPLY_PUB stage_apply;
  class PERS_SCHEMA,PERS_PROFILE,PERS_LOG stage_pers;
  class PP_CAND,PP_EVAL,PP_SEL,PP_RETRY,LIB_CAND,LIB_EVAL,LIB_SEL,LIB_RETRY,BP_CAND,BP_EVAL,BP_SEL,BP_RETRY,ABORT das_gate;
  class DAS_CFG das_cfg;
  class N_AUTH,N_AUTH2,N_OUT,N_PERS,N_DAS,N_DAS2,N_SSE,N_DRY,N_APPLY,N_APPLY2,N_PP,N_PP2 note;
  class TODO_ASP_EVAL,TODO_GRADER,TODO_COST todo;

  %% Tested status styling
  class IN_SPEC,IN_RUN,OUT_DIR,PERS_SCHEMA,PERS_PROFILE,PERS_LOG,PROMPT_PACK,PP_CAND,PP_EVAL,PP_SEL,PP_RETRY,PP_OUT,PP_LOG,AUTH_READ,DAS_CFG,LIB_GEN,LIB_CAND,LIB_EVAL,LIB_SEL,LIB_RETRY,LIB_OUT,BP_GEN,BP_CAND,BP_EVAL,BP_SEL,BP_RETRY,BP_OUT,REQ_REVIEW,OUT_REVIEW_REQ,REQ_BANNER,OUT_BANNER_REQ,AI_REVIEW,OUT_REVIEWS,AI_BANNER,OUT_BANNERS,VAL,OUT_VAL,PAYLOAD,OUT_PAYLOAD,RUNLOG,DONE,APPLY_START,APPLY_INV,APPLY_BP,APPLY_BANNER,APPLY_REVIEW,APPLY_PUB done;
  class ABORT,TODO_ASP_EVAL,TODO_GRADER,TODO_COST todo;
