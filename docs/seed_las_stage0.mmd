flowchart TD
  ST0([STAGE Inputs]) -.-> A
  ST1([STAGE Generate Library]) -.-> H
  ST2([STAGE Generate Blueprints]) -.-> I
  ST3([STAGE Stage 0.5 Execute AI]) -.-> R
  ST4([STAGE Stage 1 Apply Mode]) -.-> T0

  %% Stage-based styling (Mermaid v11+)
  classDef stage_marker fill:#0b1220,stroke:#253047,color:#e7eefc,stroke-width:1px;
  classDef stage_inputs fill:#102a43,stroke:#1e4e8c,color:#e7f0ff;
  classDef stage_lib fill:#0f3d2e,stroke:#1b6b4b,color:#e7fff2;
  classDef stage_bps fill:#3a2a10,stroke:#8a5b12,color:#fff4e5;
  classDef stage_ai fill:#3b1030,stroke:#7d1f66,color:#ffe8f7;
  classDef stage_apply fill:#2a133a,stroke:#5b2a88,color:#f4eaff;
  classDef note fill:#111827,stroke:#374151,color:#e5e7eb,stroke-dasharray: 3 3;
  classDef done fill:#0b2f1a,stroke:#1f8a3a,color:#eafff1;
  classDef not_tested fill:#2f2f2f,stroke:#6b7280,color:#f3f4f6;

  A["ID:A seed/seed_spec_v0.json (Seed Spec) TESTED_OK"] --> B["ID:B seed_stage0.ts (parse args + validate spec) TESTED_OK"]
  B --> C["ID:C Create run folder seed/outputs/RUN_ID/ TESTED_OK"]
  C --> G["ID:G Read SEED_USER_ACCESS_TOKEN TESTED_OK"]
  G --> H["ID:H n1 generate_library POST /api/generate-inventory TESTED_OK"]
  H --> H1["ID:H1 Write library.json TESTED_OK"]

  H1 --> I["ID:I n2 generate_blueprints POST /api/generate-blueprint TESTED_OK"]
  I --> I1["ID:I1 Write blueprints.json TESTED_OK"]

  I1 --> J["ID:J n3 build review_requests (no network) TESTED_OK"]
  J --> J1["ID:J1 Write review_requests.json TESTED_OK"]

  J1 --> K["ID:K n4 build banner_requests (no network) TESTED_OK"]
  K --> K1["ID:K1 Write banner_requests.json TESTED_OK"]

  K1 -.-> R["ID:R n3.5 execute_review POST /api/analyze-blueprint TESTED_OK"]
  R --> R1["ID:R1 Write reviews.json TESTED_OK"]

  R1 -.-> S["ID:S n4.5 execute_banner POST /api/generate-banner dryRun TESTED_OK"]
  S --> S1["ID:S1 Write banners.json TESTED_OK"]

  K1 --> L["ID:L n5 validate category+item references TESTED_OK"]
  S1 -.-> L
  L --> L1["ID:L1 Write validation.json TESTED_OK"]

  L1 --> M["ID:M n6 publish_payload (no writes) TESTED_OK"]
  M --> M1["ID:M1 Write publish_payload.json TESTED_OK"]

  M1 --> N["ID:N Append run_log.json timings+status TESTED_OK"]
  N --> Z

  Z["ID:Z Done (artifacts only) TESTED_OK"]

  %% Notes (hexagons) - point into nodes with key context
  NX1{{NOTE access token expires refresh often}} --> G
  NX1B{{NOTE auth supports SEED_USER_REFRESH_TOKEN and auth store}} --> G
  NX1C{{NOTE refresh flow verified by clearing access token in auth store}} --> G
  NX2{{NOTE analyze-blueprint is SSE runner stitches text}} --> R
  NX3{{NOTE generate-banner dryRun returns base64 no Storage}} --> S
  NX4{{NOTE image generation can be rate limited or safety rejected}} --> S
  NX5{{NOTE seed outputs ignored do not commit artifacts}} --> C

  %% Stage 1 apply mode nodes (implemented in seed_stage0.ts)
  M1 -.-> T0["ID:T0 Stage 1 apply mode TESTED_OK"]
  T0 --> T1["ID:T1 Insert library/inventory into DB TESTED_OK"]
  T1 --> T2["ID:T2 Insert blueprint drafts into DB TESTED_OK"]
  T2 --> T3["ID:T3 Upload banner via upload-banner edge function TESTED_OK"]
  T3 --> T4["ID:T4 Persist review text to blueprint row TESTED_OK"]
  T4 --> T5["ID:T5 Publish public blueprint finalize TESTED_OK"]

  NX6{{NOTE apply mode gated with --apply and --yes APPLY_STAGE1}} --> T0
  NX7{{NOTE writes apply_log json and rollback sql in the run folder}} --> T0
  NX8{{NOTE publish sets is_public true on created rows}} --> T5
  NX9{{NOTE Stage1 test run stage1-test-20260207-183213 inv 4f8c826f bp 3e122c58}} --> T0

  %% Assign stage classes
  class ST0,ST1,ST2,ST3,ST4 stage_marker;

  class A,B,C,G stage_inputs;
  class H,H1 stage_lib;
  class I,I1,J,J1,K,K1 stage_bps;
  class R,R1,S,S1 stage_ai;
  class T0,T1,T2,T3,T4,T5 stage_apply;
  class L,L1,M,M1,N,Z stage_inputs;

  class NX1,NX1B,NX1C,NX2,NX3,NX4,NX5,NX6,NX7,NX8,NX9 note;

  %% Tested status styling
  class A,B,C,G,H,H1,I,I1,J,J1,K,K1,R,R1,S,S1,L,L1,M,M1,N,Z,T0,T1,T2,T3,T4,T5 done;
